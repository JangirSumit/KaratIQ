<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="KaratIQ.Views.BillingPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KaratIQ.ViewModels"
             xmlns:models="clr-namespace:KaratIQ.Models"
             Title="Billing">

    <Grid RowDefinitions="Auto,*,Auto,Auto">
        
        <!-- Customer Selection -->
        <StackLayout Grid.Row="0" Padding="15" BackgroundColor="LightBlue">
            <Label Text="Customer (Optional)" FontAttributes="Bold" />
            <Picker ItemsSource="{Binding Customers}"
                    SelectedItem="{Binding SelectedCustomer}"
                    ItemDisplayBinding="{Binding Name}"
                    Title="Select Customer" />
        </StackLayout>

        <!-- Invoice Items -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding InvoiceItems}"
                        Margin="10">
            <CollectionView.Header>
                <Label Text="Invoice Items" 
                       FontSize="18" 
                       FontAttributes="Bold" 
                       Margin="0,10" />
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:InvoiceItem">
                    <Grid ColumnDefinitions="*,Auto" 
                          Padding="10"
                          BackgroundColor="LightGray"
                          Margin="0,2">
                        <StackLayout Grid.Column="0">
                            <Label Text="{Binding ItemName}" FontAttributes="Bold" />
                            <Label Text="{Binding Weight, StringFormat='Weight: {0:F2}g'}" />
                            <Label Text="{Binding Rate, StringFormat='Rate: ₹{0:F2}/g'}" />
                            <Label Text="{Binding MakingCharges, StringFormat='Making: ₹{0:F2}'}" />
                            <Label Text="{Binding Amount, StringFormat='Amount: ₹{0:F2}'}" 
                                   FontAttributes="Bold" />
                        </StackLayout>
                        <Button Grid.Column="1"
                                Text="×"
                                BackgroundColor="Red"
                                TextColor="White"
                                WidthRequest="40"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BillingViewModel}}, Path=RemoveItemCommand}"
                                CommandParameter="{Binding .}" />
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Add Item Form -->
        <StackLayout Grid.Row="2" 
                     Padding="15" 
                     BackgroundColor="White"
                     Spacing="10">
            <Label Text="Add Item" FontSize="16" FontAttributes="Bold" />
            
            <Entry Placeholder="Item Name" 
                   Text="{Binding ItemName}" />
            
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <Entry Grid.Column="0"
                       Placeholder="Weight (g)" 
                       Text="{Binding Weight}"
                       Keyboard="Numeric" />
                <Entry Grid.Column="1"
                       Placeholder="Rate per gram" 
                       Text="{Binding Rate}"
                       Keyboard="Numeric" />
            </Grid>
            
            <Entry Placeholder="Making Charges" 
                   Text="{Binding MakingCharges}"
                   Keyboard="Numeric" />
            
            <Button Text="Add Item"
                    BackgroundColor="Green"
                    TextColor="White"
                    Command="{Binding AddItemCommand}" />
        </StackLayout>

        <!-- Invoice Summary -->
        <StackLayout Grid.Row="3" 
                     Padding="15" 
                     BackgroundColor="LightYellow"
                     Spacing="5">
            
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <Entry Grid.Column="0"
                       Placeholder="Discount" 
                       Text="{Binding Discount}"
                       Keyboard="Numeric" />
                <CheckBox Grid.Column="1"
                          IsChecked="{Binding IsGstApplicable}" />
            </Grid>
            <Label Text="GST Applicable" HorizontalOptions="End" Margin="0,-25,0,0" />
            
            <BoxView HeightRequest="1" BackgroundColor="Gray" Margin="0,5" />
            
            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto">
                <Label Grid.Row="0" Grid.Column="0" Text="Subtotal:" />
                <Label Grid.Row="0" Grid.Column="1" Text="{Binding SubTotal, StringFormat='₹{0:F2}'}" />
                
                <Label Grid.Row="1" Grid.Column="0" Text="Discount:" />
                <Label Grid.Row="1" Grid.Column="1" Text="{Binding Discount, StringFormat='₹{0:F2}'}" />
                
                <Label Grid.Row="2" Grid.Column="0" Text="GST (3%):" />
                <Label Grid.Row="2" Grid.Column="1" Text="{Binding GstAmount, StringFormat='₹{0:F2}'}" />
                
                <Label Grid.Row="3" Grid.Column="0" Text="Total:" FontAttributes="Bold" FontSize="18" />
                <Label Grid.Row="3" Grid.Column="1" Text="{Binding TotalAmount, StringFormat='₹{0:F2}'}" 
                       FontAttributes="Bold" FontSize="18" />
            </Grid>
            
            <Button Text="Generate Invoice"
                    BackgroundColor="Blue"
                    TextColor="White"
                    Command="{Binding GenerateInvoiceCommand}"
                    Margin="0,10,0,0" />
        </StackLayout>
    </Grid>
</ContentPage>